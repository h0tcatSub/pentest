$(function() {
	var param = common.getQueryString();

	if (!param.trade_cd) {
		common.systemErrorPage('E0001');
	}

	$('#calculated-price-tr').hide();
	var urlBasic = PROPERTY.API_CASHLESS_BASIC_URL + '?trade_cd=' + param.trade_cd;
	var currentPage = 1;
	var tradeCd = '';
	var sortName1 = '';
	var sortOrder1 = '';
	var totalPrice = '88888888';
	var charge_key = '';
	var payment_key = '';

	common.executeApi(urlBasic, null, 'httpGetApiCall', 'GET').done(function(data, textStatus, jqXHR) {
		createBasicInfo(data.item);
		tradeCd = data.item.trade_cd;
		charge_key = data.item.charge;
		payment_key = data.item.payment;
		// 雋ｷ蜿悶せ繝��繧ｿ繧ｹ縺悟叙蠑募ｮ御ｺ�(逹驥大ｾ�■繝輔Λ繧ｰ:ON)縺九▽莉｣驥大女蜿匁婿豕輔′"譛ｪ驕ｸ謚�"縺ｮ蝣ｴ蜷井ｻ･螟悶�縲∵髪謇墓婿豕暮∈謚槭�蜈･蜉帑ｸ榊庄
		if( !("60" == data.item.sell_stat && data.item.payment == null) || 0 == data.item.total_price){
			$('input[type="radio"]').prop("disabled", true);
			$("#cashlessAuthBtn").prop("disabled", true);
			$('#collapsePym').collapse('hide');
			$('.h2-pym').hide()
		} else {
			$("#cashlessAuthBtn").prop("disabled", true);
		}
		data.item.total_price = 88888888
		totalPrice = data.item.total_price;
		let urlGetPaymentFeeInfo = PROPERTY.API_CASHLESS_PAYMENTFEEINFO_URL;
		common.executeApi(urlGetPaymentFeeInfo, null, 'httpGetApiCall', 'GET').done(async function(data, textStatus, jqXHR) {

			// 窶ｻ蜷郁ｨ磯≡鬘阪′髢ｾ蛟､(荳矩剞)譛ｪ貅縺ｮ蝣ｴ蜷医�驕ｸ謚樔ｸ榊庄
			console.log(data)
			// 縺頑髪謇穂ｻ｣驥題｡ｨ遉ｺ
			setPaymentPrices(data, totalPrice);

			// 逹驥第焔謨ｰ譁呵ｨｭ螳�
			setModalFeeMsges(data);

			// 逹驥第焔謨ｰ譁吶�蝗ｺ螳壽枚險
			showFeeMsg(data);

			// 隱崎ｨｼ蜃ｦ逅�ｾ後�繝ｪ繝繧､繝ｬ繧ｯ繝医°繝√ぉ繝�け
			if (param.auth_result) {
				let result = param.auth_result;
				// 繝壹�繧ｸ蜀崎ｪｭ縺ｿ霎ｼ縺ｿ譎ゅ↓蜷後§謖吝虚縺ｨ縺ｪ繧峨↑縺�ｈ縺�Μ繝繧､繝ｬ繧ｯ繝育ｵ先棡諠��ｱ繧貞炎髯､
				let url = new URL(location);
				url.searchParams.delete("auth_result");
				history.replaceState('','', url.toString());

				// PayPay隱崎ｨｼ繝ｪ繝繧､繝ｬ繧ｯ繝育ｵ先棡縺梧�蜉溘�蝣ｴ蜷医∬�蜍輔〒謾ｯ謇墓婿豕戊ｨｭ螳哂PI繧偵さ繝ｼ繝ｫ
				if (result == PROPERTY.RE_PARAM_SUCCEEDED) {
					await dispPaypaySelected();
					let json = {};
					json.pay_tp = $(".charge_paypay").find(".pay_tp").text();
					json.charge_kbn = $(".charge_paypay").find(".charge_kbn").text();
					json.line_pay_number = "";
					// 隱崎ｨｼ蜃ｦ逅�ｾ後ヵ繝ｩ繧ｰ繧堤ｫ九※繧�
					json.is_paypay_auth_flg = 1;
					cashlessCharge.callSetPaymentTypeAPI(param.trade_cd, json);
				} else {
					$("#authFailedModal").modal("show");
				}
			}

		}).fail(function(jqXHR, textStatus, errorThrown) {
			common.systemErrorPage('E0000');
		});

		var urlDtl = PROPERTY.API_CASHLESS_DETAIL_URL + '?trade_cd=' + tradeCd;
		common.executeApi(urlDtl, null, 'httpGetApiCall', 'GET').done(function(data, textStatus, jqXHR) {
			createDetailInfo (data.items, urlDtl);
			// 驕主悉蜿門ｼ墓髪謇墓ュ蝣ｱ蜿門ｾ�
			let urlListTrade = PROPERTY.API_CASHLESS_LISTTRADE_URL + '?trade_cd=' + param.trade_cd;
			let json ={};
			// 讀懃ｴ｢譚｡莉ｶ
			let sell_stat = '60';// 蜿門ｼ募ｮ御ｺ�
			let charge_kbn = '05';// LINE Pay
			urlListTrade =  common.updateQueryStringParameter(urlListTrade, "sell_stat", sell_stat);
			urlListTrade =  common.updateQueryStringParameter(urlListTrade, "charge_kbn", charge_kbn);

			common.executeApi(urlListTrade, null, 'httpGetApiCall', 'GET').done(function(data, textStatus, jqXHR) {
				setListTradeByTradeCode(data);

			}).fail(function(jqXHR, textStatus, errorThrown) {
				common.systemErrorPage('E0000');
			});

		}).fail(function(jqXHR, textStatus, errorThrown) {
			messageHandler(jqXHR, 'E0002');

		});
	}).fail(function(jqXHR, textStatus, errorThrown) {
		var errCd = jqXHR.responseJSON.result.err_cd;
		// 蜿門ｼ輔さ繝ｼ繝牙ｾｩ蜿ｷ螟ｱ謨励�繧ｱ繝ｼ繧ｹ
		if (errCd == 'E2005') {
			messageHandler(jqXHR, 'E0003');
		} else {
			messageHandler(jqXHR, 'E0001');
		}
	});

	function removePaytypeSelection(data, totalPrice) {
		if(isUnderthleshold(data, "01", totalPrice)){
			$(".charge_docomo").remove();
		}
		if(isUnderthleshold(data, "02", totalPrice)){
			$(".charge_au").remove();
		}
		if(isUnderthleshold(data, "03", totalPrice)){
			$(".charge_softbank").remove();
		}
		if(isUnderthleshold(data, "04", totalPrice)){
			$(".charge_kyash").remove();
		}
		if(isUnderthleshold(data, "05", totalPrice)){
			$(".charge_line").remove();
		}
		if(isUnderthleshold(data, "06", totalPrice)){
			$(".charge_paypay").remove();
		}
	}

	function isUnderthleshold(data, key, totalPrice) {
		let feeInfo = data.feeInfo.feeInfo;
		for(var i = 0; i < feeInfo.length; i++){
			if(key == feeInfo[i]["charge_kbn"]){
				if(totalPrice < feeInfo[i]["threshold"]){
					return true;
				}
			}
		}
		return false;
	}

	function setPaymentPrices(data, totalPrice) {
		$('.rcvDcm').text(common.commaSeparator(calcPaymentPrice(data, "01", totalPrice)) + '蜀�');
		$('.rcvAu').text(common.commaSeparator(calcPaymentPrice(data, "02", totalPrice)) + '蜀�');
		$('.rcvSb').text(common.commaSeparator(calcPaymentPrice(data, "03", totalPrice)) + '蜀�');
		$('.rcvKy').text(common.commaSeparator(calcPaymentPrice(data, "04", totalPrice)) + '蜀�');
		$('.rcvLp').text(common.commaSeparator(calcPaymentPrice(data, "05", totalPrice)) + '蜀�');
		$('.rcvPp').text(common.commaSeparator(calcPaymentPrice(data, "06", totalPrice)) + '蜀�');
		// 蝓ｺ譛ｬ諠��ｱ縺ｮ縺頑髪謇暮≡鬘崎ｨｭ螳�
		if ('蜿門ｼ募ｮ御ｺ�' == $('#sts').text()) {
			showCalculatedPrice(data, totalPrice);
		}
	}

	function showCalculatedPrice(data, totalPrice) {
		if ("A" == payment_key) {
			$('#calculated-price').html(common.commaSeparator(calcPaymentPrice(data, charge_key, totalPrice)) + '蜀�');
		}
		if ("8" == payment_key) {
			$('#calculated-price').html(common.commaSeparator(totalPrice) + '繝昴う繝ｳ繝�');
		}
		if ("B" == payment_key) {
			$('#calculated-price').html('0蜀�(蜈ｨ鬘榊ｯ�ｻ�)');
		}
		$('#calculated-price-tr').show();
	}

	function calcPaymentPrice(data, key, totalPrice) {
		let feeInfo = data.feeInfo.feeInfo;
		for(var i = 0; i < feeInfo.length; i++){
			if(key == feeInfo[i]["charge_kbn"]){
				return total_price = totalPrice - feeInfo[i]["fee"] <= 0 ? 0 : totalPrice - feeInfo[i]["fee"];
			}
		}
	}

	function setModalFeeMsges(data) {
		let msgFirst = "(逹驥第焔謨ｰ譁�";
		let msgLast = "蜀�ｷｮ縺怜ｼ輔″貂�)";
		$('.modalFeeMsgDcm').text(msgFirst + setModalFeeMsge(data, "01") + msgLast);
		$('.modalFeeMsgAu').text(msgFirst + setModalFeeMsge(data, "02") + msgLast);
		$('.modalFeeMsgSb').text(msgFirst + setModalFeeMsge(data, "03") + msgLast);
		$('.modalFeeMsgKy').text(msgFirst + setModalFeeMsge(data, "04") + msgLast);
		$('.modalFeeMsgLp').text(msgFirst + setModalFeeMsge(data, "05") + msgLast);
		$('.modalFeeMsgPp').text(msgFirst + setModalFeeMsge(data, "06") + msgLast);
	}

	function setModalFeeMsge(data, key) {
		let feeInfo = data.feeInfo.feeInfo;
		for(var i = 0; i < feeInfo.length; i++){
			if(key == feeInfo[i]["charge_kbn"]){
				return feeInfo[i]["fee"];
			}
		}
	}

	function showFeeMsg(data) {
		let feeInfo = data.feeInfo.feeInfo;
		let dispFee = 0;
		for(var i = 0; i < feeInfo.length; i++){
			if( 'A' == feeInfo[i]["pay_tp"]){
				dispFee = feeInfo[i]["fee"];
				break;
			}
		}
		if (0 != dispFee) {
			$('#feeMsg').html('窶ｻ險育ｮ礼ｵ先棡縺ｮ縺秘｣邨｡縺九ｉ1騾ｱ髢鍋ｵ碁℃縺励※繧ょ女蜿匁婿豕輔ｒ驕ｸ縺ｰ繧後↑縺九▲縺溷�ｴ蜷医�縲√後ヶ繝�け繧ｪ繝戊ｲｷ蜿悶�繧､繝ｳ繝医阪〒縺ｮ蜿怜叙縺ｨ縺ｪ繧翫∪縺吶�<br>窶ｻ縲後ヶ繝�け繧ｪ繝戊ｲｷ蜿悶�繧､繝ｳ繝医阪→縲悟ｯ�ｻ倥堺ｻ･螟悶�蜿怜叙譁ｹ豕輔ｒ驕ｸ縺ｰ繧後◆蝣ｴ蜷医�縲∬ｲｷ蜿門粋險磯≡鬘阪ｈ繧顔捩驥第焔謨ｰ譁�' + dispFee + '蜀�ｒ蟾ｮ縺怜ｼ輔°縺帙※縺�◆縺�縺阪∪縺吶�');
			$('#feeMsg').show();
		}
	}

	/**
	 * 蝓ｺ譛ｬ諠��ｱ險ｭ螳�
	 * @item item
	 */
	function createBasicInfo (item) {
		$('#cd').text(item.trade_cd);
		$('#sts').text(getSts(item));
		$('#payment').text(getPayment(item));
		$('#qty').text(item.goods_qty ? item.goods_qty + '轤ｹ' : '0轤ｹ');
		$('#rec-dt').text(item.rec_dt ? common.dateTimeFormat(item.rec_dt) : '');
		$('#store-nm').text(item.rec_store_nm ? common.contentHTML(item.rec_store_nm) : '');
		$('#total-price').text(item.total_price ? common.commaSeparator(item.total_price) + '蜀�' : '0蜀�');
		$('#extra-price').text(item.extra_price ? common.commaSeparator(item.extra_price) + '蜀�' : '0蜀�');
		$('#liq-qty').text(item.liq_qty ? item.liq_qty + '轤ｹ' : '0轤ｹ');
		$('#liq-dt').text(item.posliq_dt ? common.dateFormat(item.posliq_dt) : '');

		$('#guideMsg').html('莉･荳九�繧ｵ繝ｼ繝薙せ繧医ｊ縲∬ｲｷ蜿紋ｻ｣驥代�蜿怜叙譁ｹ豕輔ｒ縺企∈縺ｳ縺上□縺輔＞縲�');
		$('#guideMsg').show();
		$('#paymentNotice').html('窶ｻ驕ｸ謚槭＆繧後◆蜷�女蜿匁婿豕輔�諠��ｱ縺ｨ縲∝ｺ鈴�ｭ蜿嶺ｻ俶凾縺ｫ逋ｻ骭ｲ縺励◆縲後♀蜷榊燕縲阪碁崕隧ｱ逡ｪ蜿ｷ縲阪′蜷郁�縺励↑縺��ｴ蜷医�縲∫捩驥代お繝ｩ繝ｼ縺ｨ縺ｪ繧翫∪縺吶�縺ｧ縺疲ｳｨ諢上￥縺�縺輔＞縲�');
		$('#paymentNotice').show();
		$('#effectivePeriod').html(common.isEmpty(item.effective_period) ? '' : '譛牙柑譛滄剞�壼女蜿匁律縺九ｉ' + Math.floor(item.effective_period)  + '譌･');
		$('#effectivePeriod').show();
		let addPointMsg = common.isEmpty(item.add_point) ? '' :'縲後ヶ繝�け繧ｪ繝戊ｲｷ蜿悶�繧､繝ｳ繝医阪〒縺ｮ蜿怜叙繧帝∈謚槭＆繧後◆蝣ｴ蜷医�' + item.add_point + 'pt繝励Ξ繧ｼ繝ｳ繝茨ｼ�';
		let effectivePeriodMsg = common.isEmpty(item.inc_effective_period) ? '' :'�域怏蜉ｹ譛滄剞' + Math.floor(item.inc_effective_period / 31)+'繝ｶ譛茨ｼ�';
		$('#addPointMsg').html(addPointMsg ? addPointMsg + effectivePeriodMsg : '');
		$('#addPointMsg').show();


		$('.rcvPo').html(item.total_price ? common.commaSeparator(item.total_price) + '繝昴う繝ｳ繝�' : '0繝昴う繝ｳ繝�');
		$('.rcvDo').html('0蜀�(蜈ｨ鬘榊ｯ�ｻ�)');
	}

	function getSts(item) {
		if(item.sell_stat){
			if(('A' == item.payment || item.payment == null) && item.sell_stat == '60'){
				if((item.statusCd == 'YSDS000' || item.statusCd =='YSDS69' || item.statusCd == '20000002')){
					return '蜿門ｼ募ｮ御ｺ�';
				} else {
					return '逹驥大ｾ�■';
				}
			} else {
				return item.sell_stat_nm;
			}
		} else return '';
	}

	/**
	 * 謾ｯ謇募玄蛻�錐遘ｰ蜿門ｾ�
	 * @item item
	 */
	function getPayment (item) {
		if (item.payment == PROPRTY_CONST.CHARGE) {
			return item.payment_nm + '��' + (item.charge_nm ? item.charge_nm : '') + '��';
		}
		return item.payment_nm ? item.payment_nm : '';
	}

	/**
	 * 譏守ｴｰ諠��ｱ險ｭ螳�
	 * @item item
	 * @url url
	 */
	function createDetailInfo (items, url) {

		if (!items.attribute.total) {
			showMessage(getMessageId('I0001') + '<br>');
			return;
		}

		$('#tbl-dtl').show();

		var columnNo = 0;
		if (items.attribute.page_num != 1) {
			columnNo = 10 * (items.attribute.page_num - 1);
		}

		var row = '';
		$.each(items.result,function(index,elm) {
			row = row + '<tr class="search-result">';
			row = row + '<td class="text-center">' + (index + columnNo + 1)  + '</td>';
			row = row + '<td class="text-left">' + common.avoidNull(elm.classification_nm) + '</td>';
			row = row + '<td class="text-left">' + common.avoidNull(elm.bumon_nm) + '</td>';
			row = row + '<td class="text-left">' + common.avoidNull(elm.title) + '</td>';
			row = row + '<td class="text-right">' + common.avoidNull(elm.qty) + '</td>';
			row = row + '<td class="text-right">' + common.avoidNull(common.commaSeparator(elm.extra_unit_price));
			var extra_price = common.avoidNull(common.commaSeparator(elm.extra_price));
			if (extra_price == '0') {
				row = row + '</td></tr>';
			} else {
				row = row + '<br>(' + extra_price + ')</td></tr>';
			}

			$('#pagination').twbsPagination({
				totalPages: Math.ceil(items.attribute.total / PROPRTY_CONST.PAGE_MAX),
				onPageClick: function (event, page) {

					if (currentPage == page) {
						return;
					}
					$('.search-result').remove();
					currentPage = page;
					var urlDtl = url
					+ '&max_record=' + PROPRTY_CONST.PAGE_MAX
					+ '&page_num=' +  page;

					if (sortName1) {
						urlDtl = urlDtl + '&sort_name1=' + sortName1 + '&sort_order1=' + sortOrder1;
					}

					common.executeApi(urlDtl, null, 'httpGetApiCall', 'GET').done(function(data, textStatus, jqXHR) {
						createDetailInfo (data.items, urlDtl);
					}).fail(function(jqXHR, textStatus, errorThrown) {
						messageHandler(jqXHR, 'E0002');
					});
				}
			});
		});
		$('#tbl-dtl').append(row);
	}

	// 驕主悉蜿門ｼ墓髪謇墓ュ蝣ｱ繧段nput隕∫ｴ�縺ｫ險ｭ螳�
	function setListTradeByTradeCode(data){
		if (data.result.records.length != 0) {
			var line_pay_id = data.result.records[0].line_pay_id;
		}
		if(line_pay_id){
			let first7 = '*******';
			let last4 = line_pay_id.slice(-4);
			$('#linePayNumberKnwn').val(first7 + last4);
			$('#linePayNumberKnwnForSubmit').val(line_pay_id);
		}
	}

	/**
	 * 繧ｽ繝ｼ繝亥�逅�
	 */
	$('.tbl-header').on('click', function(event) {
		event.preventDefault();
		event.stopPropagation();
		var orderDesc = $('input[id=order]');
		sortName1 = $(this).attr('id');
		orderDesc.val(sortName1);
		sortName1 = sortName1.slice(0,-5);
		sortOrder1 = 'DESC';

		var desc = orderDesc.attr('data-desc');
		if (!desc) {
			orderDesc.attr('data-desc','笆ｽ');
		} else if (desc == '笆ｳ') {
			orderDesc.attr('data-desc','笆ｽ');
		} else {
			orderDesc.attr('data-desc','笆ｳ');
			sortOrder1 = 'ASC'
		}

		// 繧ｽ繝ｼ繝育泙蜊ｰ險ｭ螳�
		addOrderArrow();

		var urlDtl = PROPERTY.API_CASHLESS_DETAIL_URL
		+ '?trade_cd=' + tradeCd
		+ '&max_record=' + PROPRTY_CONST.PAGE_MAX
		+ '&page_num=' + currentPage
		+ '&sort_name1=' + sortName1
		+ '&sort_order1=' + sortOrder1;

		common.executeApi(urlDtl, null, 'httpGetApiCall', 'GET').done(function(data, textStatus, jqXHR) {
			$('.search-result').remove();
			createDetailInfo (data.items, urlDtl);
		}).fail(function(jqXHR, textStatus, errorThrown) {
			messageHandler(jqXHR, 'E0002');
		});
	})

	/**
	 * 繧ｽ繝ｼ繝育泙蜊ｰ
	 */
	function addOrderArrow() {
		var order = $('input[id=order]');
		var orderDesc = order.val();
		var orderArrow = order.attr('data-desc');
		if (orderDesc) {
			$('.sort-arrow').empty();
			$('#tbl-dtl a[id=' + orderDesc + '] span').append(orderArrow);
		}
	}

	/**
	 * 繝｡繝�そ繝ｼ繧ｸ繝上Φ繝峨Λ
	 * @jqXHR jqXHR
	 * @id id
	 */
	function messageHandler(jqXHR, id) {
		var sts = common.httpStatus(jqXHR);
		if (sts == 0 || sts == 1) {
			showMessage(getMessageId(id) + '<br>');
		} else if (sts == 2) {
			common.systemErrorPage(id);
		}
	}

	/**
	 * 繝｡繝�そ繝ｼ繧ｸ陦ｨ遉ｺ
	 * @jqXHR jqXHR
	 * @id id
	 */
	function showMessage (msg) {
		$('.msg-txt').html(msg);
		$('.msg-txt').show();
	}

	/**
	 * 繝｡繝�そ繝ｼ繧ｸ險ｭ螳�
	 * @jqXHR jqXHR
	 * @id id
	 */
	function getMessageId (id) {
		if (id == 'E0001') {
			return MESSAGE_CONST.E0001;
		} else if (id == 'E0002') {
			return MESSAGE_CONST.E0002;
		} else if (id == 'E0003') {
			return MESSAGE_CONST.E0003;
		} else if (id == 'I0001') {
			return MESSAGE_CONST.I0001;
		} else {
			return '';
		}
	}

	/**
	 * PayPay驕ｸ謚樊凾縺ｮ迥ｶ諷九ｒ陦ｨ遉ｺ縺吶ｋ
	 * @return Promise
	 */
	function dispPaypaySelected() {
		return new Promise(resolve => {
			$("[id=pp]").prop("checked", true);
			$(".linePayNumberForm").hide();
			$(".donationForm").hide();
			$(".chargeAuAcd").hide();
			$(".chargeKyashAcd").hide();
			$(".chargeDocomoAcd").hide();
			$(".chargeSoftbankAcd").hide();
			$(".chargePaypayAcd").show();
			cashlessCharge.setConfirmModalText();
			$("#cashlessAuthBtn").prop("disabled", false);
			$("#confirmModal").modal("show");
			resolve();
		});
	}
});
