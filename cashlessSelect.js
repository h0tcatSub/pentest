$(function () {

  $(".linePayNumberForm").hide();
  $(".donationForm").hide();
  $(".chargeAuAcd").hide();
  $(".chargeKyashAcd").hide();
  $(".chargeDocomoAcd").hide();
  $(".chargeSoftbankAcd").hide();
  $(".chargePaypayAcd").hide();

  // 「同意する」セレクトボックスが全てチェックされているかどうかで「次へ」ボタンの活性/非活性を制御するイベント
  $('[id^="agreeChk"]').on("click", function () {
    if ($('[id^="agreeChk"]:not(:checked)').length == 0) {
      $("#cashlessAuthBtn").prop("disabled", false);
    } else {
      $("#cashlessAuthBtn").prop("disabled", true);
    }
  });

  $('[name="radioGroup"]:radio').on("change", function () {
    if ($("[id=lp]").prop("checked")) {
      // LINEPayを選択した時にLINEPayナンバー入力欄を表示する
      $(".donationForm").hide();
      $(".chargeAuAcd").hide();
      $(".chargeKyashAcd").hide();
      $(".chargePaypayAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".linePayNumberForm").show();
      $("#cashlessAuthBtn").prop("disabled", true);
      isValidLinePayNumber();
    } else if ($("[id=don]").prop("checked")) {
      // 寄付を選択したときに寄付同意項目を表示する
      $(".donationForm").show();
      $(".linePayNumberForm").hide();
      $(".chargeKyashAcd").hide();
      $(".chargeAuAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".chargePaypayAcd").hide();
      if ($('[id^="agreeChk"]:not(:checked)').length == 0) {
        $("#cashlessAuthBtn").prop("disabled", false);
      } else {
        $("#cashlessAuthBtn").prop("disabled", true);
      }
    } else if ($("[id=au]").prop("checked")) {
      // au WALLETを選択したときにau WALLETに関する注意文言を表示する
      $(".linePayNumberForm").hide();
      $(".donationForm").hide();
      $(".chargeKyashAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".chargeAuAcd").show();
      $(".chargePaypayAcd").hide();
      $("#cashlessAuthBtn").prop("disabled", false);
    } else if ($("[id=ky]").prop("checked")) {
      // Kyashを選択したときにKyashに関する注意文言を表示する
      $(".linePayNumberForm").hide();
      $(".donationForm").hide();
      $(".chargeAuAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".chargeKyashAcd").show();
      $(".chargePaypayAcd").hide();
      $("#cashlessAuthBtn").prop("disabled", false);
    } else if ($("[id=dcm]").prop("checked")) {
      // ドコモ口座を選択したときにドコモ口座に関する注意文言を表示する
      $(".linePayNumberForm").hide();
      $(".donationForm").hide();
      $(".chargeAuAcd").hide();
      $(".chargeKyashAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".chargeDocomoAcd").show();
      $(".chargePaypayAcd").hide();
      $("#cashlessAuthBtn").prop("disabled", false);
    } else if ($("[id=sb]").prop("checked")) {
      // ソフトバンクカードを選択したときにソフトバンクカードに関する注意文言を表示する
      $(".linePayNumberForm").hide();
      $(".donationForm").hide();
      $(".chargeAuAcd").hide();
      $(".chargeKyashAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").show();
      $(".chargePaypayAcd").hide();
      $("#cashlessAuthBtn").prop("disabled", false);
    } else if ($("[id=pp]").prop("checked")) {
      // PayPayを選択したときにPayPayに関する注意文言を表示する
      $(".linePayNumberForm").hide();
      $(".donationForm").hide();
      $(".chargeAuAcd").hide();
      $(".chargeKyashAcd").hide();
      $(".chargeDocomoAcd").hide();
      $(".chargeSoftbankAcd").hide();
      $(".chargePaypayAcd").show();
      $("#cashlessAuthBtn").prop("disabled", false);
    }else {
      // 「LinePay」または「寄付」または「au WALLET」または「Kyash」または「ドコモ口座」または「ソフトバンクカード」
      //以外のラジオボタンをチェックした場合は
      // LineNumber入力欄・同意項目などのアコーディオンを共に非表示にする
      $(".linePayNumberForm, .donationForm, .chargeAuAcd, .chargeKyashAcd, .chargeDocomoAcd, .chargeSoftbankAcd, .chargePaypayAcd").hide();
      // 次へボタンを活性化
      $("#cashlessAuthBtn").prop("disabled", false);
    }
  });

  // LinePayナンバー入力欄が変化した場合にLinePayNumberチェック
  $("#linePayNumberNew, #linePayNumberKnwn").on("keydown keyup keypress change input", function () {
    isValidLinePayNumber();
  });

  // 登録済み/新規登録のラジオボタン選択が変化した場合にLinePayNumberチェック
  $('[name="radioGroup2"]:radio').on("change", function () {
    $("#cashlessAuthBtn").prop("disabled", true);
    isValidLinePayNumber();
  });

  // 「次へ」をクリックしたときに、選択した支払方法をダイアログに設定する
  $("#cashlessAuthBtn").on("click", function () {
    cashlessCharge.setConfirmModalText();
  });

  let param = common.getQueryString();
  // 確定ボタン
  $("#confirmBtn").on("click", function (event) {
    event.preventDefault();
    if (!param.trade_cd) {
      common.systemErrorPage('E0001');
    }

    let json = {};
    json.pay_tp = $("input[name='radioGroup']:checked").parents("tr").find(".pay_tp").text();
    json.charge_kbn = $("input[name='radioGroup']:checked").parents("tr").find(".charge_kbn").text();
    json.line_pay_number = json.charge_kbn =="05"? getChkedLineNumberVal() : "";
    json.is_paypay_auth_flg = json.charge_kbn =="06"? 0 : "";

    cashlessCharge.callSetPaymentTypeAPI(param.trade_cd, json);
  });

  // 手続き完了モーダルのクローズで画面のリロード
  $("#completeModal").on('hidden.bs.modal', function () {
    window.location.href = '/bo-member-tkh/selectpayment/' + '?trade_cd=' + param.trade_cd;
  });

  // 買取ポイント切り替えモーダルのクローズで画面のリロード
  $("#errorModal").on('hidden.bs.modal', function () {
    window.location.href = '/bo-member-tkh/selectpayment/' + '?trade_cd=' + param.trade_cd;
  });

  // 例外エラーモーダルのクローズで画面のリロード
  $("#exceptionModal").on('hidden.bs.modal', function () {
    window.location.href = '/bo-member-tkh/selectpayment/' + '?trade_cd=' + param.trade_cd;
  });

  $("[data-toggle=tooltip]").tooltip();

  //チェックされている方のLINEPayナンバーのinput要素の値を返す
  function getChkedLineNumberVal(){
	  return $("input[name='radioGroup2']:checked").parent().parent().find(".line_pay_number").val();
  }

  /**
   * メッセージハンドラ
   *
   * @jqXHR jqXHR
   * @id id
   */
  function messageHandler(jqXHR, id) {
    var sts = common.httpStatus(jqXHR);
    if (sts == 0 || sts == 1) {
    	cashlessCharge.showMessage(getMessageId(id) + '<br>');
    } else if (sts == 2) {
      common.systemErrorPage(id);
    }
  }

  function showMessageLineNum(msg) {
    $('.lineNm-msg-txt').html(msg);
    $('.lineNm-msg-txt').show();
  }
  /**
   * メッセージ設定
   *
   * @jqXHR jqXHR
   * @id id
   */
  function getMessageId(id) {
    if (id == 'E0001') {
      return MESSAGE_CONST.E0001;
    } else {
      return '';
    }
  }

  function isNumber(param) {
    var regex = /^[0-9]*$/;
    return regex.test(param);
  }

  function lengthCheck(target, length) {
    if (target.length != length) {
      return false;
    }
    return true;
  }

  function isValidLinePayNumber() {
	let lineNumber = getChkedLineNumberVal();
	if(lineNumber) {
		if(isNumber(lineNumber) && lengthCheck(lineNumber, 11)){
			$('.lineNm-msg-txt').hide();
			$("#cashlessAuthBtn").prop("disabled", false);
		}else {
			$("#cashlessAuthBtn").prop("disabled", true);
			showMessageLineNum("11桁の数値を入力してください<br>");
		}
	}
  }


});
